<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>gproj design notes • gproj</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css"><script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet"><script src="pkgdown.js"></script><meta property="og:title" content="gproj design notes"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-title-body">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">gproj</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mdsumner/gproj/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="contents col-md-9">
    <div class="page-header">
      <h1>gproj design notes</h1>
    </div>

<div id="gproj-design-notes" class="section level1">

<div class="section level2">
<h2 id="identity">Identity<a class="anchor" aria-label="anchor" href="#identity"></a></h2>
<p>gproj is a <strong>projection concierge</strong>: given coordinates or a region of interest, it tells you what projection to use and gives you the transform. It’s not spatial infrastructure — it sits between “I have lon/lat data” and “I need a sensible projected view”.</p>
</div>
<div class="section level2">
<h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>
<ul><li>
<strong>S7</strong>: class system</li>
<li>
<strong>reproj</strong>: coordinate transformation (wraps PROJ)</li>
<li>
<strong>geographiclib</strong> (optional, Phase 3): geodesic area/distance</li>
</ul></div>
<div class="section level2">
<h2 id="phase-1-core-current">Phase 1: Core (current)<a class="anchor" aria-label="anchor" href="#phase-1-core-current"></a></h2>
<div class="section level3">
<h3 id="classes">Classes<a class="anchor" aria-label="anchor" href="#classes"></a></h3>
<p><strong><code>gproj(crs)</code></strong> — S7 object storing a CRS string, with <code>@proj_xy</code> (forward) and <code>@proj_ll</code> (inverse) methods. Identity when crs is empty.</p>
<p><strong><code>params(xy)</code> / <code>params(lon, lat)</code></strong> — Characterises the geometry of a coordinate set: - <code>@centre</code> — lon_0, lat_0 (column mean; TODO: circular mean for antimeridian) - <code>@extent_ll</code> — bounding box in longlat - <code>@span</code> — angular extent in degrees - <code>@hemisphere</code> — polar_south/north, mid_south/north, equatorial - <code>@aspect</code> — wide/tall/square (lon_span vs lat_span ratio) - <code>@axis</code> — PCA on 3D cartesian: azimuth, tilt, variance_ratio - <code>@secant</code> — lat_1/lat_2 for conic projections</p>
</div>
<div class="section level3">
<h3 id="functions">Functions<a class="anchor" aria-label="anchor" href="#functions"></a></h3>
<p><strong><code>proj(params, family)</code></strong> — Generates a PROJ string. <code>family</code> can be: - A PROJ name: “laea”, “stere”, “omerc”, “lcc”, “ortho”, “aeqd”, etc. - A property: “equal_area”, “equidistant”, “conformal” - “auto” — picks family from data geometry (the textbook decision tree)</p>
<p><strong><code>gproj_region(lon, lat, radius_km, property)</code></strong> — Quick entry point: “equal area centred here, 500km radius”. Returns gproj + extent.</p>
<p><strong><code>grid_spec(region, resolution_m)</code></strong> — Target grid specification from a region.</p>
</div>
<div class="section level3">
<h3 id="mercator-devolution-detection-foundation-for-phase-2">Mercator devolution detection (foundation for Phase 2)<a class="anchor" aria-label="anchor" href="#mercator-devolution-detection-foundation-for-phase-2"></a></h3>
<p><strong><code>test_mercator_spacing(lat_values)</code></strong> — Tests if 1D latitude sequence follows Mercator y-spacing: <code>y = R * ln(tan(π/4 + φ/2))</code>. Converts lat to Mercator y, checks if diff(merc_y) is constant.</p>
<p><strong><code>test_regular_spacing(values)</code></strong> — Tests if a 1D coordinate sequence has uniform spacing.</p>
<p><strong><code>detect_rectilinear(lon_2d, lat_2d)</code></strong> — Tests if 2D coordinate arrays are rectilinear (lon varies only along one axis, lat along the other). Classifies as: - <code>regular_lonlat</code> — uniform spacing in both lon and lat - <code>mercator_devolved</code> — uniform lon, Mercator-spaced lat - <code>rectilinear_nonuniform</code> — rectilinear but neither regular nor Mercator</p>
</div>
</div>
<div class="section level2">
<h2 id="phase-2-detect_grid-planned">Phase 2: detect_grid (planned)<a class="anchor" aria-label="anchor" href="#phase-2-detect_grid-planned"></a></h2>
<p>The full grid detection pipeline for “cryptic curvilinear” data.</p>
<div class="section level3">
<h3 id="algorithm">Algorithm<a class="anchor" aria-label="anchor" href="#algorithm"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Rectilinear test</strong> (from Phase 1): check if lon/lat arrays are separable</li>
<li>
<strong>Candidate CRS generation</strong>: use params() centre + hemisphere to pick candidates</li>
<li>
<strong>Regularity test in projected space</strong>:
<ul><li>Project lon/lat to candidate CRS (subsample: edges + cross suffice)</li>
<li>For each row: is diff(x) constant?</li>
<li>For each column: is diff(y) constant?</li>
<li>Are row-y values constant (rows truly horizontal)?</li>
</ul></li>
<li>
<strong>Resolution snapping</strong>: 24999.84 → 25000</li>
<li>
<strong>Half-cell extent recovery</strong>: cell centres + resolution → true grid extent</li>
<li>
<strong>EPSG matching</strong>: compare detected CRS + resolution against known grid database</li>
</ol></div>
<div class="section level3">
<h3 id="the-centre-trick">The “centre trick”<a class="anchor" aria-label="anchor" href="#the-centre-trick"></a></h3>
<p>Even without a candidate database, project to <code>+proj=stere +lat_0={detected} +lon_0={detected}</code> (or lcc, etc. based on hemisphere) and test regularity. If regular, you’ve found the family. Then search EPSG for a match.</p>
</div>
<div class="section level3">
<h3 id="output-detect_gridlon-lat-returns">Output: detect_grid(lon, lat) returns<a class="anchor" aria-label="anchor" href="#output-detect_gridlon-lat-returns"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span><span class="op">@</span><span class="va">type</span>        <span class="co"># "regular_projected" | "rectilinear_lonlat" | "mercator_devolved" | "curvilinear"</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">crs</span>         <span class="co"># "EPSG:3412" or PROJ string</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">resolution</span>  <span class="co"># c(25000, 25000)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">extent</span>      <span class="co"># c(-3950000, 3950000, -3950000, 4350000)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">dimensions</span>  <span class="co"># c(316, 332)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">confidence</span>  <span class="co"># 0-1</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">residuals</span>   <span class="co"># max deviation from perfect grid (CRS units)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">gproj</span>       <span class="co"># ready-to-use gproj object</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">grid_spec</span>   <span class="co"># list(crs, extent, res, dim)</span></span>
<span><span class="va">result</span><span class="op">@</span><span class="va">gdal_args</span>   <span class="co"># c("-a_srs", "EPSG:3412", "-a_ullr", ...) for immediate use</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="known-grid-database-internal-data">Known grid database (internal data)<a class="anchor" aria-label="anchor" href="#known-grid-database-internal-data"></a></h3>
<p>Common gridded product CRSs with typical resolutions:</p>
<table class="table"><thead><tr class="header"><th>CRS</th>
<th>Res (m)</th>
<th>Domain</th>
<th>Products</th>
</tr></thead><tbody><tr class="odd"><td>EPSG:3412</td>
<td>25000</td>
<td>Antarctic sea ice</td>
<td>NSIDC Bootstrap/NASA Team</td>
</tr><tr class="even"><td>EPSG:3413</td>
<td>25000</td>
<td>Arctic sea ice</td>
<td>NSIDC</td>
</tr><tr class="odd"><td>EPSG:3031</td>
<td>various</td>
<td>Antarctic</td>
<td>BAS, AAD, many</td>
</tr><tr class="even"><td>EPSG:3976</td>
<td>25000</td>
<td>Antarctic sea ice</td>
<td>NSIDC alt</td>
</tr><tr class="odd"><td>EPSG:3995</td>
<td>various</td>
<td>Arctic</td>
<td>various</td>
</tr><tr class="even"><td>+proj=merc</td>
<td>various</td>
<td>Global ocean</td>
<td>AVISO, GHRSST, Copernicus</td>
</tr><tr class="odd"><td>+proj=lcc (Euro)</td>
<td>12000-50000</td>
<td>Europe</td>
<td>CORDEX, EURO-CORDEX, WRF</td>
</tr><tr class="even"><td>+proj=stere +lat_0=90</td>
<td>various</td>
<td>Arctic</td>
<td>ERA5 reduced</td>
</tr></tbody></table></div>
</div>
<div class="section level2">
<h2 id="phase-3-geodesic-operations-planned">Phase 3: Geodesic operations (planned)<a class="anchor" aria-label="anchor" href="#phase-3-geodesic-operations-planned"></a></h2>
<p>If geographiclib is available: - <code>geodesic_area(lonlat_polygon)</code> — exact ellipsoidal area - <code>geodesic_distance(lon1, lat1, lon2, lat2)</code> — exact ellipsoidal distance - <code>geodesic_line(lon1, lat1, lon2, lat2, n)</code> — points along a geodesic</p>
<p>Otherwise fallback to spherical approximations.</p>
</div>
<div class="section level2">
<h2 id="key-insight-the-entropy-problem">Key insight: the entropy problem<a class="anchor" aria-label="anchor" href="#key-insight-the-entropy-problem"></a></h2>
<p>A “cryptic curvilinear” grid stores N×M×2 coordinate values that can be replaced by 4 numbers (extent) + 1 string (CRS). That’s a compression ratio of ~35,000:1 for a 316×332 grid, and it’s <em>lossless</em> — better than the original because the lon/lat arrays introduce floating-point noise.</p>
<p>The goal of detect_grid() is to discover this latent structure automatically.</p>
</div>
<div class="section level2">
<h2 id="antimeridian-handling-todo">Antimeridian handling (TODO)<a class="anchor" aria-label="anchor" href="#antimeridian-handling-todo"></a></h2>
<p>params() currently uses simple column mean for centre. Needs circular mean for datasets spanning ±180. Detection: if max(lon) - min(lon) &gt; 350 and there are values near both -180 and 180, shift to 0-360 before computing centre.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>

</div>



      <footer><div class="copyright">
  <p></p><p>Developed by Michael D. Sumner.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer></div>






  </body></html>

